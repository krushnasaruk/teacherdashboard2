<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher Dashboard - DPCE</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root{
      --sidebar-w: 240px;
      --bg-a: #0a0e1a;
      --bg-b: #141b2d;
      --surface: rgba(255,255,255,0.05);
      --muted: #94a3b8;
      --card-shadow: rgba(0,0,0,0.4);
      --accent-1: linear-gradient(135deg,#10b981 0%, #059669 100%);
      --accent-2: linear-gradient(135deg,#3b82f6 0%, #1d4ed8 100%);
      --accent-3: linear-gradient(135deg,#f59e0b 0%, #d97706 100%);
      --accent-4: linear-gradient(135deg,#8b5cf6 0%, #7c3aed 100%);
      --glass: rgba(255,255,255,0.04);
      --text: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border: rgba(255,255,255,0.08);
      --hover: rgba(255,255,255,0.06);
    }

    .light-theme{
      --bg-a: #fefefe;
      --bg-b: #f8fafc;
      --surface: rgba(15,23,42,0.03);
      --muted: #64748b;
      --card-shadow: rgba(15,23,42,0.08);
      --accent-1: linear-gradient(135deg,#059669 0%, #047857 100%);
      --accent-2: linear-gradient(135deg,#2563eb 0%, #1d4ed8 100%);
      --accent-3: linear-gradient(135deg,#d97706 0%, #b45309 100%);
      --accent-4: linear-gradient(135deg,#7c3aed 0%, #6d28d9 100%);
      --glass: rgba(15,23,42,0.02);
      --text: #0f172a;
      --text-secondary: #475569;
      --border: rgba(15,23,42,0.08);
      --hover: rgba(15,23,42,0.04);
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}

    html,body{height:100%}
    body{
      min-height:100vh;
      height:100vh;
      background: linear-gradient(180deg,var(--bg-a), var(--bg-b));
      color:var(--text);
      display:flex;
      transition: background .35s ease, color .35s ease;
      overflow:hidden;
    }

    .sidebar{
      width:var(--sidebar-w);
      min-width:var(--sidebar-w);
      background: var(--bg-b);
      padding:24px 20px;
      border-right: 1px solid var(--border);
      position:sticky;
      top:0;
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:8px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      z-index:95;
    }

    .brand{
      font-weight:700;
      letter-spacing:0.2px;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
    }

    .logo {
      width:40px;height:40px;border-radius:12px;
      background: var(--accent-3);
      display:inline-block;
      box-shadow: 0 4px 12px rgba(245,158,11,0.3);
    }

    nav{margin-top:16px;flex:1;overflow:auto}
    .nav-item{
      display:flex;align-items:center;gap:14px;padding:12px 16px;border-radius:12px;color:var(--muted);
      text-decoration:none;cursor:pointer;
      transition: all .2s ease;
      user-select:none;
      margin-bottom:4px;
      font-weight:500;
    }
    .nav-item:hover{ 
      background:var(--hover); 
      color:var(--text); 
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .nav-item.active{ 
      background: var(--accent-3); 
      color: white; 
      box-shadow: 0 4px 16px rgba(245,158,11,0.3);
      transform: translateX(4px);
    }

    .nav-label{font-size:15px}
    .sidebar .bottom {
      margin-top:auto;
      font-size:13px;color:var(--muted);
    }

    .main {
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      overflow-y:auto;
      overflow-x:hidden;
    }

    .topbar{
      height:72px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 28px;
      background: var(--bg-a);
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(12px);
    }

    .topbar-left{display:flex;align-items:center;gap:12px}
    .hamburger {
      display:none;
      width:44px;height:44px;border-radius:10px;background:var(--glass);border:none;color:var(--text);
      align-items:center;justify-content:center;font-size:20px;cursor:pointer;
    }

    .topbar .search {
      display:flex;align-items:center;gap:8px;
      background:var(--glass);padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.02);
      min-width:240px;max-width:420px;
    }
    .topbar .search input{
      border:0;background:transparent;outline:none;color:var(--text);
      width:100%;
    }

    .topbar-right{display:flex;align-items:center;gap:12px}

    .icon-btn{
      width:44px;height:44px;border-radius:12px;background:var(--glass);
      display:flex;align-items:center;justify-content:center;border:0;
      cursor:pointer;color:var(--text);transition:all 0.2s ease;
      border:1px solid var(--border);
    }
    .icon-btn:hover{
      background:var(--hover);transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }

    .avatar{
      width:44px;height:44px;border-radius:50%;border:2px solid var(--border);
      background:var(--accent-3);
      display:flex;align-items:center;justify-content:center;cursor:pointer;
      font-weight:700;color:white;font-size:16px;
      transition:all 0.2s ease;box-shadow:0 2px 8px rgba(245,158,11,0.3);
    }
    .avatar:hover{
      transform:translateY(-2px);box-shadow:0 4px 16px rgba(245,158,11,0.4);
    }

    .theme-toggle{
      width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,#111, #2b2b2b);
      display:grid;place-items:center;border:0;cursor:pointer;color:#fff;font-size:14px;
    }

    .content-wrapper{
      width:100%;
      max-width:1200px;
      margin:24px auto;
      padding:0 24px 40px;
      flex:1;
    }

    .greeting{
      display:flex;justify-content:space-between;align-items:flex-start;
      gap:12px;
      margin-bottom:18px;
    }

    .greeting h1{font-size:20px;margin-bottom:6px}
    .greeting p{color:var(--muted);font-size:14px;margin-top:2px}

    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
      gap:18px;
    }

    .card{
      background: var(--surface);
      padding:24px;border-radius:16px;box-shadow:0 4px 20px var(--card-shadow);
      transition:all .3s ease;
      border: 1px solid var(--border);
      backdrop-filter: blur(8px);
    }
    .card:hover{
      transform:translateY(-8px);
      box-shadow:0 12px 40px var(--card-shadow);
      border-color: rgba(245,158,11,0.2);
    }

    .card .title{font-size:13px;color:var(--muted);margin-bottom:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    .card .big{font-size:28px;font-weight:800;color:var(--text);margin-bottom:8px}

    .prog-wrap{
      margin-top:16px;background:var(--border);height:8px;border-radius:8px;overflow:hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .prog {
      height:100%;border-radius:8px;width:80%;
      transition: width 1s ease;
      position:relative;
    }

    .grid-2col{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:24px;
      margin-top:20px;
      align-items:start;
    }

    .class-schedule{
      margin-top:20px;border-radius:16px;padding:24px;
      background:var(--surface);border:1px solid var(--border);
      box-shadow:0 4px 20px var(--card-shadow);
    }
    .class-schedule h3{margin-bottom:16px;color:var(--text);font-weight:700}
    .schedule{display:flex;flex-direction:column;gap:12px}
    .slot{
      display:flex;justify-content:space-between;padding:16px;border-radius:12px;
      background:var(--hover);align-items:center;
      transition:all 0.2s ease;border:1px solid var(--border);
    }
    .slot:hover{transform:translateX(4px);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .slot .time{font-weight:700;color:var(--text)}
    .slot .sub{color:var(--muted);font-size:14px;font-weight:500}

    .student-list{
      background: var(--surface);
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--card-shadow);
      margin-top: 20px;
      border: 1px solid var(--border);
    }
    
    .student-list h3 {
      margin-bottom: 16px;
      color: var(--text);
      font-weight: 700;
    }
    
    .students {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .student {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      border-radius: 8px;
      background: var(--hover);
      align-items: center;
      transition: all 0.2s ease;
      border: 1px solid var(--border);
    }
    
    .student:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .student .name {
      font-weight: 600;
      color: var(--text);
    }
    
    .student .status {
      color: var(--muted);
      font-size: 12px;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 12px;
      background: var(--accent-1);
      color: white;
    }

    .quick-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      max-width: 300px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      border-left: 4px solid var(--accent-1);
    }

    .notification.warning {
      border-left: 4px solid var(--accent-3);
    }

    .notification.info {
      border-left: 4px solid var(--accent-2);
    }

    .current-class {
      background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(16,185,129,0.1)) !important;
      border: 2px solid var(--accent-3) !important;
      animation: pulse 3s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @media (max-width:880px){
      .sidebar{display:none;position:fixed;left:0;top:0;z-index:120;height:100vh}
      .sidebar.mobile-open{display:block;width:80vw;max-width:300px;box-shadow:6px 0 24px rgba(0,0,0,0.4);z-index:120}
      .hamburger{display:flex}
      .topbar .search{display:none}
      .grid-2col{grid-template-columns:1fr}
      .content-wrapper{max-width:100%;padding:0 12px 60px}
      .cards{grid-template-columns:1fr 1fr;gap:12px}
      .card{padding:14px}
      .card .big{font-size:18px}
      /* Hide clock on mobile */
      #current-time{display:none}
      /* Notes modal mobile layout */
      #notes-modal .notes-container{width:100% !important;height:100% !important;max-height:100vh !important;border-radius:0 !important}
      #notes-modal .notes-grid{grid-template-columns:1fr !important}
      #notes-modal .notes-grid > div:first-child{max-height:40vh;overflow:auto}
      #notes-modal .notes-grid > div:last-child{min-height:0}
      #notes-modal .ntb{padding:6px 8px}
    }

    .muted{color:var(--muted)}
    a{color:inherit}
    button{background:none;border:0}
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar" aria-label="Main sidebar">
    <div class="brand">
      <span class="logo" aria-hidden="true"></span>
      <div>
        <div style="font-size:15px;font-weight:700;color:var(--text)">Dr. Sarah Johnson</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px">Teacher ID: T12345</div>
      </div>
    </div>

    <nav>
      <div class="nav-item active" data-section="dashboard">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 13h4v8H3zM8.5 3h4v18h-4zM17 8h4v13h-4z" fill="currentColor" opacity="0.9"/></svg>
        <div class="nav-label">Dashboard</div>
      </div>

      <div class="nav-item" data-section="attendance">
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M4 6h16v12H4z" fill="currentColor" opacity="0.9" /></svg>
        <div class="nav-label">Attendance</div>
      </div>

      <div class="nav-item" data-section="classes">
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 2a7 7 0 017 7c0 5-7 13-7 13S5 14 5 9a7 7 0 017-7z" fill="currentColor" opacity="0.9"/></svg>
        <div class="nav-label">My Classes</div>
      </div>

      <div class="nav-item" data-section="students">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor" opacity="0.9"/></svg>
        <div class="nav-label">Students</div>
      </div>

      <div class="nav-item" data-section="grades">
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M7 3h10v2H7zM7 7h10v2H7zM7 11h10v2H7z" fill="currentColor" opacity="0.9"/></svg>
        <div class="nav-label">Grades</div>
      </div>

      <div class="nav-item" data-section="reports">
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 8a4 4 0 100 8 4 4 0 000-8z" fill="currentColor" opacity="0.9"/></svg>
        <div class="nav-label">Reports</div>
      </div>

      <div class="nav-item" data-section="settings">
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 8a4 4 0 100 8 4 4 0 000-8z" fill="currentColor" opacity="0.9"/></svg>
        <div class="nav-label">Settings</div>
      </div>
    </nav>

    <div class="bottom muted">
      ¬© <span id="year"></span> DPCE Teacher Portal
    </div>
  </aside>

  <!-- Student QR Scanner Modal -->
  <div id="qr-scanner-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-b); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; text-align: center; border: 1px solid var(--border);">
      <h3 style="margin-bottom: 16px; color: var(--text);">Scan QR Code</h3>
      <div id="qr-reader" style="width: 100%; max-width: 300px; margin: 0 auto 16px;"></div>
      <p style="color: var(--muted); font-size: 14px; margin-bottom: 16px;">Point your camera at the QR code to mark attendance</p>
      <button id="close-scanner-btn" style="padding: 10px 20px; background: var(--accent-3); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
    </div>
  </div>

  <!-- QR Generator & Attendance Modal -->
  <div id="qr-generator-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-b); border-radius: 16px; padding: 24px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: var(--text);">Class Attendance Management</h3>
        <button id="close-generator-btn" style="padding: 8px 12px; background: var(--accent-3); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï</button>
      </div>
      
      <!-- Class Selection -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">Select Class:</label>
        <select id="class-selector" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-size: 14px;">
          <option value="">Choose a class...</option>
          <option value="math-a">Mathematics-I (Division A)</option>
          <option value="physics-b">Physics (Division B)</option>
          <option value="math-c">Mathematics-II (Division C)</option>
          <option value="chem-lab">Chemistry Lab (Division A)</option>
        </select>
      </div>

      <!-- QR Code Section -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div style="text-align: center;">
          <h4 style="color: var(--text); margin-bottom: 12px;">QR Code for Attendance</h4>
          <div id="qr-generator" style="width: 100%; max-width: 250px; margin: 0 auto 12px; min-height: 250px; background: var(--hover); border: 2px dashed var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
            <div style="font-size: 48px; margin-bottom: 8px;">üì±</div>
            <div style="color: var(--muted); text-align: center; padding: 0 16px;">Select a class to generate QR code</div>
          </div>
          <button id="generate-qr-btn-modal" style="padding: 8px 16px; background: var(--accent-2); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 8px;">Generate QR</button>
          <button id="copy-qr-btn" style="padding: 8px 16px; background: var(--accent-1); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Copy Code</button>
        </div>

        <!-- Manual Attendance -->
        <div>
          <h4 style="color: var(--text); margin-bottom: 12px;">Manual Attendance</h4>
          <div id="attendance-summary" style="background: var(--hover); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center;">
              <div>
                <div style="font-size: 20px; font-weight: 700; color: var(--accent-1);" id="present-count">0</div>
                <div style="font-size: 12px; color: var(--muted);">Present</div>
              </div>
              <div>
                <div style="font-size: 20px; font-weight: 700; color: var(--accent-3);" id="absent-count">0</div>
                <div style="font-size: 12px; color: var(--muted);">Absent</div>
              </div>
              <div>
                <div style="font-size: 20px; font-weight: 700; color: var(--accent-2);" id="total-count">0</div>
                <div style="font-size: 12px; color: var(--muted);">Total</div>
              </div>
            </div>
          </div>
          <button id="save-attendance-btn" style="width: 100%; padding: 10px; background: var(--accent-1); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 12px;">Save Attendance</button>
          <button id="reset-attendance-btn" style="width: 100%; padding: 8px; background: var(--accent-3); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Reset All</button>
        </div>
      </div>

      <!-- Student List -->
      <div id="student-list-container" style="display: none;">
        <h4 style="color: var(--text); margin-bottom: 12px;">Student List</h4>
        <div id="student-list" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
          <!-- Student list will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Modal -->
  <div id="notes-modal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
    <div class="notes-container" style="background: var(--bg-b); border:1px solid var(--border); border-radius:16px; width:95%; max-width:1000px; max-height:92vh; display:flex; flex-direction:column; overflow:hidden;">
      <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border);">
        <div style="font-weight:700">Notes</div>
        <div style="display:flex; gap:8px; align-items:center">
          <input id="notes-search" placeholder="Search notes..." style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text); min-width:220px" />
          <select id="notes-sort" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text);">
            <option value="updated-desc">Recently updated</option>
            <option value="updated-asc">Oldest updated</option>
            <option value="created-desc">Recently created</option>
            <option value="created-asc">Oldest created</option>
            <option value="title-asc">Title A‚ÜíZ</option>
            <option value="title-desc">Title Z‚ÜíA</option>
          </select>
          <button id="close-notes-btn" style="padding:8px 10px; background:var(--accent-3); color:white; border-radius:8px; font-weight:600;">‚úï</button>
        </div>
      </div>
      <div class="notes-grid" style="display:grid; grid-template-columns:320px 1fr; gap:0; flex:1; min-height:0;">
        <div style="border-right:1px solid var(--border); overflow:auto;">
          <div style="padding:12px; display:flex; gap:8px;">
            <button id="new-note-btn" style="flex:1; padding:10px; background:var(--accent-2); color:white; border-radius:8px; font-weight:700;">+ New Note</button>
          </div>
          <div id="notes-list" style="padding:8px; display:flex; flex-direction:column; gap:8px;"></div>
        </div>
        <div style="display:flex; flex-direction:column; min-width:0;">
          <div style="display:flex; align-items:center; gap:8px; padding:10px; border-bottom:1px solid var(--border); flex-wrap:wrap;">
            <input id="note-title" placeholder="Title" style="flex:1; min-width:160px; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-weight:700;" />
            <input id="note-tags" placeholder="tags (comma separated)" style="min-width:160px; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text);" />
            <input type="color" id="note-color" title="Note color" />
            <button id="pin-note-btn" title="Pin" style="padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--surface); color:var(--text);">üìå</button>
            <button id="delete-note-btn" title="Delete" style="padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--surface); color:var(--text);">üóëÔ∏è</button>
            <button id="export-notes-btn" title="Export" style="padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--surface); color:var(--text);">‚¨áÔ∏è Export</button>
            <input id="import-notes-input" type="file" accept="application/json" style="display:none" />
            <button id="import-notes-btn" title="Import" style="padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--surface); color:var(--text);">‚¨ÜÔ∏è Import</button>
          </div>
          <div style="display:flex; align-items:center; gap:6px; padding:8px; border-bottom:1px solid var(--border); flex-wrap:wrap;">
            <button class="ntb" data-cmd="bold">B</button>
            <button class="ntb" data-cmd="italic"><i>i</i></button>
            <button class="ntb" data-cmd="underline"><u>U</u></button>
            <button class="ntb" data-cmd="strikeThrough"><s>S</s></button>
            <button class="ntb" data-cmd="insertUnorderedList">‚Ä¢ List</button>
            <button class="ntb" data-cmd="insertOrderedList">1. List</button>
            <button class="ntb" id="checkbox-list-btn">‚òë Checklist</button>
            <button class="ntb" data-cmd="undo">‚Ü∂</button>
            <button class="ntb" data-cmd="redo">‚Ü∑</button>
            <button class="ntb" id="link-btn">üîó Link</button>
            <input type="color" id="text-color" title="Text color" />
            <input type="color" id="hilite-color" title="Highlight" />
            <button class="ntb" id="clear-format-btn">Clear</button>
          </div>
          <div id="note-editor" contenteditable="true" style="flex:1; padding:14px; outline:none; overflow:auto; background:var(--surface);"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notification-container"></div>

  <!-- MAIN -->
  <div class="main">
    <header class="topbar">
      <div class="topbar-left">
        <button class="hamburger" id="hamburger" aria-label="Open menu">‚ò∞</button>
        <div style="display:flex;flex-direction:column;">
          <div style="font-weight:700">Teacher Dashboard</div>
          <div style="font-size:12px;color:var(--muted)">Welcome back, Dr. Johnson</div>
        </div>
        <div id="current-time" style="margin-left: 20px; padding: 8px 16px; background: var(--glass); border-radius: 12px; font-family: 'Courier New', monospace; font-weight: 600; border: 1px solid var(--border);">
          <div id="time-display" style="font-size: 18px; color: var(--text);"></div>
          <div id="date-display" style="font-size: 12px; color: var(--muted); margin-top: 2px;"></div>
        </div>
      </div>

      <div class="topbar-right" style="display:flex;align-items:center;gap:12px">
        <div class="search" title="Search">
          <svg width="16" height="16" viewBox="0 0 24 24" style="opacity:.8"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
          <input id="searchInput" placeholder="Search students, classes..." aria-label="Search" />
        </div>

        <button class="icon-btn" id="generate-qr-btn" title="Generate QR Code" aria-label="Generate QR Code">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M3 7V3h4M21 3h-4v4M3 17v4h4M21 17v4h-4M8 12h8M12 8v8" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="9" y="9" width="6" height="6" fill="currentColor" opacity="0.3"/>
          </svg>
        </button>

        <button class="theme-toggle" id="themeToggle" title="Toggle theme" aria-label="Toggle theme">üåì</button>

        <div style="position:relative">
          <div class="avatar" id="avatarBtn" title="Account menu" aria-label="Account">SJ</div>
          <div id="profileMenu" style="display:none; position:absolute;right:0;top:48px; background:var(--surface); color:var(--text); padding:10px;border-radius:10px; min-width:160px; box-shadow:0 10px 30px rgba(0,0,0,0.3)">
            <div style="font-weight:700;margin-bottom:6px">Dr. Sarah Johnson</div>
            <div class="muted" style="font-size:13px;margin-bottom:8px">sarah.johnson@dpce.edu</div>
            <hr style="border:0;height:1px;background:rgba(255,255,255,0.02);margin:6px 0"/>
            <div style="font-size:14px;cursor:pointer" id="logoutBtn">Logout</div>
          </div>
        </div>
      </div>
    </header>

    <!-- content wrapper-->
    <main class="content-wrapper">
      <div class="greeting">
        <div>
          <h1>Teacher Dashboard</h1>
          <p class="muted">Manage your classes, students, and attendance</p>
        </div>
      </div>

      <!-- Two-column layout -->
      <div class="grid-2col">
        <div>
          <div class="cards">
            <div class="card">
              <div class="title">Total Students</div>
              <div class="big">142 Students</div>
              <div class="prog-wrap"><div class="prog" style="width:95%;background:var(--accent-1)"></div></div>
            </div>

            <div class="card">
              <div class="title">Classes Today</div>
              <div class="big">4 Classes</div>
              <div class="prog-wrap"><div class="prog" style="width:80%;background:var(--accent-2)"></div></div>
            </div>

            <div class="card">
              <div class="title">Attendance Rate</div>
              <div class="big">94.2%</div>
              <div class="prog-wrap"><div class="prog" style="width:94%;background:var(--accent-3)"></div></div>
            </div>
            
            <div class="card">
              <div class="title">Pending Grades</div>
              <div class="big">23 Papers</div>
              <div class="prog-wrap"><div class="prog" style="width:60%;background:var(--accent-4)"></div></div>
            </div>
          </div>

          <!-- Today's Classes -->
          <div class="class-schedule">
            <div style="display: flex; justify-content: space-between; align-items: center; gap:8px; margin-bottom: 16px; flex-wrap:wrap;">
              <h3 id="todayScheduleDay">Today's Classes</h3>
              <div style="display:flex; gap:8px; align-items:center;">
                <select id="divisionSelector" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-size: 14px;">
                  <option value="A">Division A</option>
                  <option value="B">Division B</option>
                  <option value="C">Division C</option>
                </select>
                <button id="editTimetableBtn" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--hover); color:var(--text); font-weight:600;">‚úèÔ∏è Edit Timetable</button>
              </div>
            </div>
            <div class="schedule" id="scheduleContainer"></div>
          </div>

          <!-- Student List -->
          <div class="student-list">
            <h3>Recent Attendance</h3>
            <div class="students">
              <div class="student">
                <div class="name">Krushna Saruk</div>
                <div class="status">Present</div>
              </div>
              <div class="student">
                <div class="name">Priya Sharma</div>
                <div class="status">Present</div>
              </div>
              <div class="student">
                <div class="name">Raj Patel</div>
                <div class="status">Absent</div>
              </div>
              <div class="student">
                <div class="name">Anita Singh</div>
                <div class="status">Present</div>
              </div>
              <div class="student">
                <div class="name">Vikram Kumar</div>
                <div class="status">Late</div>
              </div>
            </div>
          </div>
        </div>

        <!-- right column -->
        <aside>
          <!-- Quick Actions -->
          <div class="card" style="margin-bottom:20px">
            <div class="title">Quick Actions</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px">
              <button class="quick-action-btn" id="mark-attendance-btn" style="padding:12px;background:var(--accent-1);color:white;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s ease;">
                üìù Mark Attendance
              </button>
              <button class="quick-action-btn" id="add-grade-btn" style="padding:12px;background:var(--accent-2);color:white;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s ease;">
                üìä Add Grade
              </button>
              <button class="quick-action-btn" id="send-notice-btn" style="padding:12px;background:var(--accent-3);color:white;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s ease;">
                üì¢ Send Notice
              </button>
          <button class="quick-action-btn" id="view-reports-btn" style="padding:12px;background:var(--accent-4);color:white;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s ease;">
            üìà Reports
          </button>
          <button class="quick-action-btn" id="scan-qr-btn" style="padding:12px;background:var(--accent-2);color:white;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s ease;">
            üì± Scan QR
          </button>
          <button class="quick-action-btn" id="bulk-attendance-btn" style="padding:12px;background:var(--accent-1);color:white;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s ease;">
            üóìÔ∏è Bulk Attendance
          </button>
            </div>
          </div>

          <!-- Current Class Status -->
          <div class="card" style="margin-bottom:20px">
            <div class="title">Current Status</div>
            <div id="current-class-status" style="margin-top:12px;padding:16px;background:var(--hover);border-radius:12px;border-left:4px solid var(--accent-2)">
              <div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:4px">Next Class</div>
              <div style="color:var(--muted);font-size:14px">Mathematics-I (Div A)</div>
              <div style="color:var(--muted);font-size:12px;margin-top:4px">In 15 minutes</div>
            </div>
          </div>

          <!-- Class Statistics -->
          <div class="card" style="margin-bottom:20px">
            <div class="title">Class Statistics</div>
            <div style="display:flex;gap:16px;align-items:center;margin-top:16px">
              <div style="flex:1;text-align:center;padding:16px;background:var(--hover);border-radius:12px">
                <div style="font-size:24px;font-weight:800;color:var(--text)">94.2%</div>
                <div style="color:var(--muted);font-size:12px;margin-top:4px">Avg Attendance</div>
              </div>
              <div style="flex:1;text-align:center;padding:16px;background:var(--hover);border-radius:12px">
                <div style="font-size:24px;font-weight:800;color:var(--text)">8</div>
                <div style="color:var(--muted);font-size:12px;margin-top:4px">Active Classes</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="title">Teacher Details</div>
            <div style="margin-top:12px" class="muted">Department</div>
            <div style="margin-bottom:8px">Mathematics</div>

            <div class="muted">Employee ID</div>
            <div style="margin-bottom:8px">T12345</div>

            <div class="muted">Experience</div>
            <div>12 Years</div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Notes quick entry card -->
  <div style="position:fixed; right:20px; bottom:20px; z-index:50; display:flex; gap:8px;">
    <button id="open-notes-fab" title="Open Notes" aria-label="Open Notes" style="width:auto; padding:12px 14px; display:flex; align-items:center; gap:8px; background: var(--accent-2); color: #fff; border: none; border-radius:12px; font-weight:700; box-shadow:0 8px 24px rgba(0,0,0,0.25);">
      üóíÔ∏è <span style="font-size:13px;">Notes</span>
    </button>
  </div>

  <!-- Edit Timetable Modal -->
  <div id="timetable-modal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
    <div style="background: var(--bg-b); border:1px solid var(--border); border-radius:16px; width:95%; max-width:700px; max-height:90vh; overflow:auto;">
      <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border)">
        <div style="font-weight:700">Edit Today's Timetable</div>
        <button id="close-timetable-btn" style="padding:6px 10px; border-radius:8px; background:var(--accent-3); color:#fff; font-weight:600;">‚úï</button>
      </div>
      <div style="padding:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <label>Division</label>
        <select id="tt-division" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text)">
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
        <label>Time</label>
        <input id="tt-time" placeholder="09:00 - 10:00" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text)" />
        <label>Subject</label>
        <input id="tt-subject" placeholder="Subject" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text)" />
        <label style="display:flex; align-items:center; gap:6px"><input type="checkbox" id="tt-break" /> Break</label>
        <button id="tt-add" style="padding:8px 12px; border-radius:8px; background:var(--accent-2); color:#fff; font-weight:700">Add</button>
      </div>
      <div style="padding:12px">
        <div class="muted" style="margin-bottom:6px">Today's Slots</div>
        <div id="tt-list" style="display:flex; flex-direction:column; gap:8px"></div>
      </div>
    </div>
  </div>

  <!-- Bulk Attendance Modal -->
  <div id="bulk-attendance-modal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
    <div style="background: var(--bg-b); border:1px solid var(--border); border-radius:16px; width:95%; max-width:840px; max-height:92vh; overflow:auto;">
      <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border)">
        <div style="font-weight:700">Bulk Attendance</div>
        <button id="bulk-close-btn" style="padding:6px 10px; border-radius:8px; background:var(--accent-3); color:#fff; font-weight:600">‚úï</button>
      </div>
      <div style="display:flex; gap:16px; padding:12px; flex-wrap:wrap; align-items:center">
        <label>Class</label>
        <select id="bulk-class" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text)"></select>
        <label>Student</label>
        <select id="bulk-student" style="min-width:220px; padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text)"></select>
        <label>Status</label>
        <select id="bulk-status" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text)">
          <option value="present">Present</option>
          <option value="absent">Absent</option>
        </select>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
          <button id="bulk-prev" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--hover); color:var(--text)">‚óÄ</button>
          <div id="bulk-month-label" class="muted" style="min-width:160px; text-align:center"></div>
          <button id="bulk-next" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--hover); color:var(--text)">‚ñ∂</button>
        </div>
      </div>
      <div style="padding:12px">
        <div id="bulk-calendar" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:8px"></div>
        <div class="muted" style="margin-top:8px; font-size:12px">Tap dates to toggle selection. Green = selected.</div>
        <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end">
          <button id="bulk-clear" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--hover); color:var(--text)">Clear</button>
          <button id="bulk-save" style="padding:8px 12px; border-radius:8px; background:var(--accent-1); color:#fff; font-weight:700">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Teacher Dashboard JavaScript
    document.addEventListener('DOMContentLoaded', () => {
      // Student data for different classes
      const classData = {
        'math-a': {
          name: 'Mathematics-I (Division A)',
          students: [
            { id: 1, name: 'Krushna Saruk', roll: 'A001', email: 'krushna@dpce.edu', phone: '9876543210' },
            { id: 2, name: 'Priya Sharma', roll: 'A002', email: 'priya@dpce.edu', phone: '9876543211' },
            { id: 3, name: 'Raj Patel', roll: 'A003', email: 'raj@dpce.edu', phone: '9876543212' },
            { id: 4, name: 'Anita Singh', roll: 'A004', email: 'anita@dpce.edu', phone: '9876543213' },
            { id: 5, name: 'Vikram Kumar', roll: 'A005', email: 'vikram@dpce.edu', phone: '9876543214' }
          ]
        },
        'physics-b': {
          name: 'Physics (Division B)',
          students: [
            { id: 6, name: 'Suresh Reddy', roll: 'B001', email: 'suresh@dpce.edu', phone: '9876543215' },
            { id: 7, name: 'Meera Joshi', roll: 'B002', email: 'meera@dpce.edu', phone: '9876543216' },
            { id: 8, name: 'Arjun Gupta', roll: 'B003', email: 'arjun@dpce.edu', phone: '9876543217' },
            { id: 9, name: 'Kavya Iyer', roll: 'B004', email: 'kavya@dpce.edu', phone: '9876543218' },
            { id: 10, name: 'Rohit Verma', roll: 'B005', email: 'rohit@dpce.edu', phone: '9876543219' }
          ]
        },
        'math-c': {
          name: 'Mathematics-II (Division C)',
          students: [
            { id: 11, name: 'Deepak Sharma', roll: 'C001', email: 'deepak@dpce.edu', phone: '9876543220' },
            { id: 12, name: 'Sneha Agarwal', roll: 'C002', email: 'sneha@dpce.edu', phone: '9876543221' },
            { id: 13, name: 'Amit Kumar', roll: 'C003', email: 'amit@dpce.edu', phone: '9876543222' },
            { id: 14, name: 'Pooja Nair', roll: 'C004', email: 'pooja@dpce.edu', phone: '9876543223' },
            { id: 15, name: 'Rahul Singh', roll: 'C005', email: 'rahul@dpce.edu', phone: '9876543224' }
          ]
        },
        'chem-lab': {
          name: 'Chemistry Lab (Division A)',
          students: [
            { id: 16, name: 'Neha Gupta', roll: 'A006', email: 'neha@dpce.edu', phone: '9876543225' },
            { id: 17, name: 'Karan Malhotra', roll: 'A007', email: 'karan@dpce.edu', phone: '9876543226' },
            { id: 18, name: 'Shreya Jain', roll: 'A008', email: 'shreya@dpce.edu', phone: '9876543227' },
            { id: 19, name: 'Aditya Rao', roll: 'A009', email: 'aditya@dpce.edu', phone: '9876543228' },
            { id: 20, name: 'Divya Reddy', roll: 'A010', email: 'divya@dpce.edu', phone: '9876543229' }
          ]
        }
      };

      let currentAttendance = {};
      let currentClass = '';
      let currentQRCode = '';
      let scanner = null;
      let attendanceRecords = []; // Store attendance records (in-memory)
      const LS_KEYS = {
        attendance: 'dpce_attendance_records',
        timetable: 'dpce_timetable_v1'
      };
      const defaultTimetable = {
        A: { }, B: { }, C: { }
      };
      // Notes state
      let notes = [];
      let activeNoteId = null;

      // Real-time clock
      function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { 
          hour12: false, 
          hour: '2-digit', 
          minute: '2-digit', 
          second: '2-digit' 
        });
        const dateString = now.toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        const timeDisplay = document.getElementById('time-display');
        const dateDisplay = document.getElementById('date-display');
        
        if (timeDisplay) timeDisplay.textContent = timeString;
        if (dateDisplay) dateDisplay.textContent = dateString;
      }

      // Notification system
      function showNotification(message, type = 'info', duration = 5000) {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 20px;">
              ${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
            </div>
            <div>
              <div style="font-weight: 600; color: var(--text); margin-bottom: 4px;">
                ${type === 'success' ? 'Success!' : type === 'warning' ? 'Warning!' : 'Info'}
              </div>
              <div style="color: var(--muted); font-size: 14px;">${message}</div>
            </div>
          </div>
        `;
        
        container.appendChild(notification);
        
        setTimeout(() => notification.classList.add('show'), 100);
        
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => container.removeChild(notification), 300);
        }, duration);
      }

      // Generate QR Code
      function generateQRCode(classId) {
        currentQRCode = `ATT_${classId}_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
        
        const qrGenerator = document.getElementById('qr-generator');
        
        // Clear the container first
        qrGenerator.innerHTML = '';
        
        // Create QR code canvas
        const canvas = document.createElement('canvas');
        canvas.id = 'qr-canvas';
        canvas.style.cssText = 'width: 200px; height: 200px; margin: 0 auto; border-radius: 12px;';
        
        // Generate QR code using the QRCode library
        QRCode.toCanvas(canvas, currentQRCode, {
          width: 200,
          height: 200,
          color: {
            dark: '#000000',
            light: '#FFFFFF'
          },
          margin: 2,
          errorCorrectionLevel: 'M'
        }, function (error) {
          if (error) {
            console.error('QR Code generation error:', error);
            qrGenerator.innerHTML = `
              <div style="width: 200px; height: 200px; margin: 0 auto; background: var(--surface); border: 2px solid var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 16px;">
                <div style="font-size: 32px; margin-bottom: 8px;">‚ùå</div>
                <div style="font-size: 10px; color: var(--muted); text-align: center;">QR Generation Failed</div>
                <div style="font-size: 8px; color: var(--muted); margin-top: 4px;">${currentQRCode}</div>
              </div>
            `;
          } else {
            console.log('QR Code generated successfully!');
            qrGenerator.innerHTML = '';
            qrGenerator.appendChild(canvas);
            
            // Add text below QR code
            const textDiv = document.createElement('div');
            textDiv.style.cssText = 'margin-top: 8px; text-align: center;';
            textDiv.innerHTML = `
              <div style="font-size: 10px; color: var(--muted); word-break: break-all; margin-bottom: 4px;">${currentQRCode}</div>
              <div style="font-size: 8px; color: var(--accent-2);">Scan to mark attendance</div>
            `;
            qrGenerator.appendChild(textDiv);
          }
        });
        
        return currentQRCode;
      }

      // Load student list for selected class
      function loadStudentList(classId) {
        const classInfo = classData[classId];
        if (!classInfo) return;

        const studentListContainer = document.getElementById('student-list-container');
        const studentList = document.getElementById('student-list');
        
        studentListContainer.style.display = 'block';
        studentList.innerHTML = '';

        // Initialize attendance for all students
        currentAttendance = {};
        classInfo.students.forEach(student => {
          currentAttendance[student.id] = 'absent'; // Default to absent
        });

        classInfo.students.forEach(student => {
          const studentDiv = document.createElement('div');
          studentDiv.className = 'student';
          studentDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); transition: all 0.2s ease;';
          
          studentDiv.innerHTML = `
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--text);">${student.name}</div>
              <div style="font-size: 12px; color: var(--muted);">Roll: ${student.roll} | ${student.email}</div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="attendance-btn present" data-student-id="${student.id}" style="padding: 6px 12px; background: var(--accent-1); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Present</button>
              <button class="attendance-btn absent" data-student-id="${student.id}" style="padding: 6px 12px; background: var(--accent-3); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Absent</button>
            </div>
          `;
          
          studentList.appendChild(studentDiv);
        });

        updateAttendanceSummary();
      }

      // Update attendance summary
      function updateAttendanceSummary() {
        const presentCount = Object.values(currentAttendance).filter(status => status === 'present').length;
        const absentCount = Object.values(currentAttendance).filter(status => status === 'absent').length;
        const totalCount = Object.keys(currentAttendance).length;

        document.getElementById('present-count').textContent = presentCount;
        document.getElementById('absent-count').textContent = absentCount;
        document.getElementById('total-count').textContent = totalCount;
      }

      // Handle attendance button clicks
      function handleAttendanceClick(studentId, status) {
        currentAttendance[studentId] = status;
        
        // Update button styles
        const buttons = document.querySelectorAll(`[data-student-id="${studentId}"]`);
        buttons.forEach(btn => {
          if (btn.textContent.toLowerCase() === status) {
            btn.style.opacity = '1';
            btn.style.transform = 'scale(1.05)';
          } else {
            btn.style.opacity = '0.6';
            btn.style.transform = 'scale(1)';
          }
        });

        updateAttendanceSummary();
      }

      // Save attendance
      function saveAttendance() {
        const classInfo = classData[currentClass];
        if (!classInfo) return;

        const attendanceRecord = {
          classId: currentClass,
          className: classInfo.name,
          date: new Date().toISOString(),
          qrCode: currentQRCode,
          students: classInfo.students.map(student => ({
            ...student,
            status: currentAttendance[student.id] || 'absent'
          }))
        };

        // Store in local records and persist to localStorage
        attendanceRecords.push(attendanceRecord);
        try {
          const prev = JSON.parse(localStorage.getItem(LS_KEYS.attendance) || '[]');
          prev.push(attendanceRecord);
          localStorage.setItem(LS_KEYS.attendance, JSON.stringify(prev));
        } catch(e) {}
        
        // Refresh recent attendance UI
        renderRecentAttendance();
        
        showNotification(`Attendance saved for ${classInfo.name}! ${Object.values(currentAttendance).filter(s => s === 'present').length} students marked present.`, 'success', 6000);
      }

      // Process scanned QR code
      function processQRCode(scannedCode) {
        console.log('Processing scanned QR code:', scannedCode);
        
        // Check if this is a valid attendance QR code
        if (scannedCode.startsWith('ATT_')) {
          const parts = scannedCode.split('_');
          const classId = parts[1];
          const timestamp = parts[2];
          
          // Find the class and update attendance
          if (classData[classId]) {
            const classInfo = classData[classId];
            const currentTime = new Date();
            const qrTime = new Date(parseInt(timestamp));
            const timeDiff = Math.abs(currentTime - qrTime);
            
            // Check if QR code is not too old (within 30 minutes)
            if (timeDiff < 30 * 60 * 1000) {
              showNotification(`QR Code scanned for ${classInfo.name}! Attendance will be marked automatically.`, 'success', 5000);
              
              // Auto-mark attendance for the class (in a real app, this would identify the specific student)
              if (currentClass === classId) {
                // If teacher is currently managing this class, show success
                showNotification('Student scanned QR code successfully!', 'success', 3000);
              }
              
              return true;
            } else {
              showNotification('QR Code has expired! Please ask teacher for a new one.', 'warning', 5000);
              return false;
            }
          } else {
            showNotification('Invalid QR Code! Please scan a valid attendance code.', 'warning', 5000);
            return false;
          }
        } else {
          showNotification('Invalid QR Code format! Please scan an attendance code.', 'warning', 5000);
          return false;
        }
      }

      // Reset attendance
      function resetAttendance() {
        Object.keys(currentAttendance).forEach(studentId => {
          currentAttendance[studentId] = 'absent';
        });

        // Reset button styles
        document.querySelectorAll('.attendance-btn').forEach(btn => {
          btn.style.opacity = '0.6';
          btn.style.transform = 'scale(1)';
        });

        updateAttendanceSummary();
        showNotification('Attendance reset for all students', 'info');
      }

      // Initialize clock
      updateClock();
      setInterval(updateClock, 1000);

      // Load attendance from LS
      function loadAttendance() {
        try {
          attendanceRecords = JSON.parse(localStorage.getItem(LS_KEYS.attendance) || '[]');
        } catch(e) { attendanceRecords = []; }
      }

      function renderRecentAttendance() {
        const container = document.querySelector('.student-list .students');
        if (!container) return;
        container.innerHTML = '';
        // take last 5 present/absent entries flattened
        const last = attendanceRecords.slice(-3).reverse();
        const rows = [];
        last.forEach(rec => {
          rec.students.slice(0,5).forEach(st => rows.push({ name: st.name, status: st.status }));
        });
        rows.slice(0,5).forEach(r => {
          const el = document.createElement('div');
          el.className = 'student';
          el.innerHTML = `
            <div class="name">${r.name}</div>
            <div class="status">${r.status.charAt(0).toUpperCase()+r.status.slice(1)}</div>
          `;
          container.appendChild(el);
        });
      }

      // Theme toggle
      const themeBtn = document.getElementById('themeToggle');
      themeBtn?.addEventListener('click', () => {
        document.body.classList.toggle('light-theme');
        try {
          const isLight = document.body.classList.contains('light-theme');
          localStorage.setItem('theme', isLight ? 'light' : 'dark');
        } catch(e) {}
      });

      // Apply saved theme
      function applySavedTheme() {
        try {
          const saved = localStorage.getItem('theme');
          const shouldBeLight = saved === 'light';
          document.body.classList.toggle('light-theme', shouldBeLight);
        } catch(e) {}
      }
      applySavedTheme();
      loadAttendance();
      renderRecentAttendance();

      // Set year
      document.getElementById('year').innerText = new Date().getFullYear();

      // Profile dropdown
      const avatarBtn = document.getElementById('avatarBtn');
      const profileMenu = document.getElementById('profileMenu');
      avatarBtn?.addEventListener('click', (e) => {
        profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block';
      });
      window.addEventListener('click', (e) => {
        if (!avatarBtn.contains(e.target) && !profileMenu.contains(e.target)) {
          profileMenu.style.display = 'none';
        }
      });

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', () => {
        window.location.href = 'login.html';
      });

      // Navigation
      const sectionToFile = {
        dashboard: 'index.html',
        attendance: 'attendance.html',
        classes: 'classes.html',
        students: 'students.html',
        grades: 'grades.html',
        reports: 'reports.html',
        settings: 'settings.html'
      };
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const section = item.getAttribute('data-section');
          const target = sectionToFile[section] || 'index.html';
          document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
          item.classList.add('active');
          if (target) {
            const current = location.pathname.split('/').pop();
            if (current !== target) {
              window.location.href = target;
            }
          }
        });
      });

      // Quick action buttons
      document.getElementById('mark-attendance-btn')?.addEventListener('click', () => {
        document.getElementById('qr-generator-modal').style.display = 'flex';
      });

      document.getElementById('add-grade-btn')?.addEventListener('click', () => {
        showNotification('Grade entry feature will be available soon!', 'info');
      });

      document.getElementById('send-notice-btn')?.addEventListener('click', () => {
        showNotification('Notice sending feature will be available soon!', 'info');
      });

      document.getElementById('view-reports-btn')?.addEventListener('click', () => {
        showNotification('Reports feature will be available soon!', 'info');
      });

      // ---- BULK ATTENDANCE ----
      const bulkModal = document.getElementById('bulk-attendance-modal');
      const bulkOpenBtn = document.getElementById('bulk-attendance-btn');
      const bulkCloseBtn = document.getElementById('bulk-close-btn');
      const bulkClassSel = document.getElementById('bulk-class');
      const bulkStudentSel = document.getElementById('bulk-student');
      const bulkStatusSel = document.getElementById('bulk-status');
      const bulkCal = document.getElementById('bulk-calendar');
      const bulkMonthLabel = document.getElementById('bulk-month-label');
      const bulkPrev = document.getElementById('bulk-prev');
      const bulkNext = document.getElementById('bulk-next');
      const bulkClear = document.getElementById('bulk-clear');
      const bulkSave = document.getElementById('bulk-save');
      let bulkYear = new Date().getFullYear();
      let bulkMonth = new Date().getMonth(); // 0-11
      let bulkSelected = new Set(); // store epoch days yyyy-mm-dd

      function ymd(date){ return date.toISOString().slice(0,10); }
      function renderBulkMonth(){
        bulkCal.innerHTML = '';
        const first = new Date(bulkYear, bulkMonth, 1);
        const startDay = first.getDay();
        const daysInMonth = new Date(bulkYear, bulkMonth+1, 0).getDate();
        bulkMonthLabel.textContent = first.toLocaleDateString(undefined, { month:'long', year:'numeric' });
        // headings
        const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        weekdays.forEach(w => {
          const h = document.createElement('div');
          h.className = 'muted';
          h.style.textAlign = 'center';
          h.style.fontSize = '12px';
          h.textContent = w;
          bulkCal.appendChild(h);
        });
        // blanks
        for (let i=0;i<startDay;i++){
          const b = document.createElement('div');
          bulkCal.appendChild(b);
        }
        // days
        for (let d=1; d<=daysInMonth; d++){
          const date = new Date(bulkYear, bulkMonth, d);
          const key = ymd(date);
          const cell = document.createElement('button');
          cell.textContent = String(d);
          cell.style.cssText = 'padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--text); cursor:pointer;';
          if (bulkSelected.has(key)) {
            cell.style.background = 'linear-gradient(135deg,#10b981,#059669)';
            cell.style.color = '#fff';
          }
          cell.addEventListener('click', () => {
            if (bulkSelected.has(key)) bulkSelected.delete(key); else bulkSelected.add(key);
            renderBulkMonth();
          });
          bulkCal.appendChild(cell);
        }
      }
      function openBulk(){
        // populate classes
        bulkClassSel.innerHTML = '<option value="">Select class...</option>' + Object.keys(classData).map(id=>`<option value="${id}">${classData[id].name}</option>`).join('');
        bulkStudentSel.innerHTML = '<option value="">Select student...</option>';
        bulkSelected.clear();
        bulkYear = new Date().getFullYear();
        bulkMonth = new Date().getMonth();
        renderBulkMonth();
        bulkModal.style.display = 'flex';
      }
      bulkOpenBtn?.addEventListener('click', openBulk);
      bulkCloseBtn?.addEventListener('click', ()=> bulkModal.style.display='none');
      bulkPrev?.addEventListener('click', ()=>{ if (--bulkMonth < 0){ bulkMonth=11; bulkYear--; } renderBulkMonth(); });
      bulkNext?.addEventListener('click', ()=>{ if (++bulkMonth > 11){ bulkMonth=0; bulkYear++; } renderBulkMonth(); });
      bulkClear?.addEventListener('click', ()=>{ bulkSelected.clear(); renderBulkMonth(); });
      bulkClassSel?.addEventListener('change', (e)=>{
        const id = e.target.value;
        bulkStudentSel.innerHTML = '<option value="">Select student...</option>';
        if (id && classData[id]){
          bulkStudentSel.innerHTML += classData[id].students.map(s=>`<option value="${s.id}">${s.name} (${s.roll})</option>`).join('');
        }
      });
      bulkSave?.addEventListener('click', ()=>{
        const classId = bulkClassSel.value;
        const studentId = parseInt(bulkStudentSel.value || '0',10);
        const status = bulkStatusSel.value || 'present';
        if (!classId || !studentId || bulkSelected.size === 0) { showNotification('Select class, student and at least one date', 'warning'); return; }
        const classInfo = classData[classId];
        const student = classInfo.students.find(s=>s.id===studentId);
        if (!student) { showNotification('Invalid student selection', 'warning'); return; }
        // load previous
        let store = [];
        try { store = JSON.parse(localStorage.getItem(LS_KEYS.attendance) || '[]'); } catch(e) { store = []; }
        // create one record per date for compatibility
        bulkSelected.forEach(key => {
          const dt = new Date(key + 'T09:00:00');
          const rec = {
            classId,
            className: classInfo.name,
            date: dt.toISOString(),
            qrCode: '',
            students: classInfo.students.map(s => ({ ...s, status: s.id===studentId ? status : 'absent' }))
          };
          store.push(rec);
        });
        try { localStorage.setItem(LS_KEYS.attendance, JSON.stringify(store)); } catch(e) {}
        // refresh local copies and UI
        loadAttendance();
        renderRecentAttendance();
        showNotification('Bulk attendance saved', 'success');
        bulkModal.style.display = 'none';
      });

      // QR Scanner functionality
      document.getElementById('scan-qr-btn')?.addEventListener('click', () => {
        document.getElementById('qr-scanner-modal').style.display = 'flex';
        
        // Initialize scanner
        scanner = new Html5Qrcode("qr-reader");
        
        scanner.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          (decodedText, decodedResult) => {
            console.log(`QR Code Scanned: ${decodedText}`);
            
            // Process the scanned QR code
            if (processQRCode(decodedText)) {
              // Stop scanner and close modal on successful scan
              scanner.stop().then(() => {
                document.getElementById('qr-scanner-modal').style.display = 'none';
              }).catch(err => {
                console.error("Error stopping the scanner", err);
              });
            }
          },
          (error) => {
            // Optional: Handle scan errors
            // console.warn(`QR scan error: ${error}`);
          }
        ).catch(err => {
          console.error("Unable to start scanning.", err);
          showNotification("Error: Could not start camera. Please grant permission.", 'warning');
        });
      });

      // Close QR scanner modal
      document.getElementById('close-scanner-btn')?.addEventListener('click', () => {
        if (scanner) {
          scanner.stop().then(() => {
            console.log("Scanner stopped.");
          }).catch(err => {
            console.error("Error stopping the scanner", err);
          });
        }
        document.getElementById('qr-scanner-modal').style.display = 'none';
      });

      // QR Code Generator Modal
      const generateQrBtn = document.getElementById('generate-qr-btn');
      const qrModal = document.getElementById('qr-generator-modal');
      const closeModalBtn = document.getElementById('close-generator-btn');
      const classSelector = document.getElementById('class-selector');
      const generateQrBtnModal = document.getElementById('generate-qr-btn-modal');
      const copyQrBtn = document.getElementById('copy-qr-btn');
      const saveAttendanceBtn = document.getElementById('save-attendance-btn');
      const resetAttendanceBtn = document.getElementById('reset-attendance-btn');

      // Open modal
      generateQrBtn?.addEventListener('click', () => {
        qrModal.style.display = 'flex';
      });

      // Close modal
      closeModalBtn?.addEventListener('click', () => {
        qrModal.style.display = 'none';
      });

      // Class selection change
      classSelector?.addEventListener('change', (e) => {
        currentClass = e.target.value;
        if (currentClass && classData[currentClass]) {
          loadStudentList(currentClass);
          generateQRCode(currentClass);
        } else {
          document.getElementById('student-list-container').style.display = 'none';
          document.getElementById('qr-generator').innerHTML = `
            <div style="font-size: 48px; margin-bottom: 8px;">üì±</div>
            <div style="color: var(--muted); text-align: center; padding: 0 16px;">Select a class to generate QR code</div>
          `;
        }
      });

      // Generate QR button
      generateQrBtnModal?.addEventListener('click', () => {
        if (currentClass) {
          const code = generateQRCode(currentClass);
          showNotification(`QR Code generated for ${classData[currentClass].name}`, 'success');
        } else {
          showNotification('Please select a class first', 'warning');
        }
      });

      // Copy QR Code
      copyQrBtn?.addEventListener('click', () => {
        if (currentQRCode) {
          navigator.clipboard.writeText(currentQRCode).then(() => {
            showNotification('QR Code copied to clipboard!', 'success');
          }).catch(() => {
            showNotification('Failed to copy QR Code', 'warning');
          });
        } else {
          showNotification('No QR Code generated yet', 'warning');
        }
      });

      // Save attendance
      saveAttendanceBtn?.addEventListener('click', () => {
        if (currentClass && Object.keys(currentAttendance).length > 0) {
          saveAttendance();
        } else {
          showNotification('No attendance data to save', 'warning');
        }
      });

      // Reset attendance
      resetAttendanceBtn?.addEventListener('click', () => {
        if (confirm('Are you sure you want to reset all attendance?')) {
          resetAttendance();
        }
      });

      // Handle attendance button clicks (delegated event listener)
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('attendance-btn')) {
          const studentId = parseInt(e.target.dataset.studentId);
          const status = e.target.textContent.toLowerCase();
          handleAttendanceClick(studentId, status);
        }
      });

      // Welcome notification removed per request

      // Mobile sidebar toggle
      const hamburger = document.getElementById('hamburger');
      const sidebar = document.getElementById('sidebar');
      let mobileOpen = false;
      
      hamburger?.addEventListener('click', () => {
        mobileOpen = !mobileOpen;
        if (window.innerWidth <= 880) {
          sidebar.classList.toggle('mobile-open', mobileOpen);
          if (mobileOpen) {
            const back = document.createElement('div');
            back.id = 'mobile-backdrop';
            back.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:90';
            back.addEventListener('click', () => { 
              mobileOpen = false; 
              sidebar.classList.remove('mobile-open'); 
              back.remove();
            });
            document.body.appendChild(back);
          } else {
            const existing = document.getElementById('mobile-backdrop'); 
            if (existing) existing.remove();
          }
        }
      });

      // Close modals on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // Close QR generator modal
          if (qrModal.style.display === 'flex') {
            qrModal.style.display = 'none';
          }
          
          // Close QR scanner modal
          const scannerModal = document.getElementById('qr-scanner-modal');
          if (scannerModal && scannerModal.style.display === 'flex') {
            if (scanner) {
              scanner.stop().catch(() => {});
            }
            scannerModal.style.display = 'none';
          }
          // Close notes modal
          const notesModal = document.getElementById('notes-modal');
          if (notesModal && notesModal.style.display === 'flex') {
            notesModal.style.display = 'none';
          }
        }
      });

      // ---------- TIMETABLE (Teacher editable; Student reads) ----------
      function getTodayKey() { return new Date().getDay(); }
      function loadTimetable() {
        try { return JSON.parse(localStorage.getItem(LS_KEYS.timetable) || 'null') || defaultTimetable; } catch(e){ return defaultTimetable; }
      }
      function saveTimetable(data) {
        try { localStorage.setItem(LS_KEYS.timetable, JSON.stringify(data)); } catch(e) {}
      }
      function renderDailyTimetable() {
        const divisionSelector = document.getElementById('divisionSelector');
        const divVal = divisionSelector ? divisionSelector.value : 'A';
        const day = getTodayKey();
        const data = loadTimetable();
        const today = data[divVal]?.[day] || { day: new Date().toLocaleDateString(undefined,{weekday:'long'}), schedule: [] };
        const heading = document.getElementById('todayScheduleDay');
        const container = document.getElementById('scheduleContainer');
        if (heading) heading.innerText = `${today.day}'s Class Timings (Division ${divVal})`;
        if (container) {
          container.innerHTML = '';
          (today.schedule||[]).forEach(slot => {
            const slotDiv = document.createElement('div');
            slotDiv.className = 'slot';
            if (slot.isBreak) slotDiv.style.background = 'var(--glass)';
            slotDiv.innerHTML = `<div class="time">${slot.time}</div><div class="sub">${slot.subject}</div>`;
            container.appendChild(slotDiv);
          });
        }
      }
      // Seed timetable if empty with a minimal sample for today A/B/C
      (function seedTimetableOnce(){
        const data = loadTimetable();
        const day = getTodayKey();
        ['A','B','C'].forEach(div=>{
          if (!data[div]) data[div] = {};
          if (!data[div][day]) data[div][day] = {
            day: new Date().toLocaleDateString(undefined,{weekday:'long'}),
            schedule: [
              { time: '09:00 - 10:00', subject: 'M-I' },
              { time: '10:00 - 11:00', subject: 'PHY' },
              { time: '11:00 - 11:15', subject: 'LUNCH', isBreak: true }
            ]
          };
        });
        saveTimetable(data);
      })();

      renderDailyTimetable();
      document.getElementById('divisionSelector')?.addEventListener('change', renderDailyTimetable);
      document.getElementById('editTimetableBtn')?.addEventListener('click', () => {
        const modal = document.getElementById('timetable-modal');
        const divSel = document.getElementById('tt-division');
        const currentDiv = document.getElementById('divisionSelector')?.value || 'A';
        if (divSel) divSel.value = currentDiv;
        renderTTList();
        modal.style.display = 'flex';
      });
      document.getElementById('close-timetable-btn')?.addEventListener('click', () => {
        document.getElementById('timetable-modal').style.display = 'none';
        renderDailyTimetable();
      });
      document.getElementById('tt-add')?.addEventListener('click', () => {
        const div = document.getElementById('tt-division').value;
        const time = document.getElementById('tt-time').value.trim();
        const subject = document.getElementById('tt-subject').value.trim();
        const isBreak = document.getElementById('tt-break').checked;
        if (!time || !subject) return;
        const data = loadTimetable();
        const day = getTodayKey();
        if (!data[div]) data[div] = {};
        if (!data[div][day]) data[div][day] = { day: new Date().toLocaleDateString(undefined,{weekday:'long'}), schedule: [] };
        data[div][day].schedule.push({ time, subject, isBreak });
        saveTimetable(data);
        document.getElementById('tt-time').value = '';
        document.getElementById('tt-subject').value = '';
        document.getElementById('tt-break').checked = false;
        renderTTList();
      });

      function renderTTList() {
        const list = document.getElementById('tt-list');
        const div = document.getElementById('tt-division').value;
        const day = getTodayKey();
        const data = loadTimetable();
        const items = data[div]?.[day]?.schedule || [];
        list.innerHTML = '';
        items.forEach((slot, idx) => {
          const row = document.createElement('div');
          row.style.cssText = 'display:flex; gap:8px; align-items:center; border:1px solid var(--border); padding:8px; border-radius:10px; background:var(--surface)';
          row.innerHTML = `
            <div style="flex:1; min-width:0; display:flex; gap:8px; align-items:center">
              <input data-tt-time="${idx}" value="${slot.time}" style="flex:0.6; min-width:120px; padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:var(--bg-b); color:var(--text)" />
              <input data-tt-subject="${idx}" value="${slot.subject}" style="flex:1; min-width:160px; padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:var(--bg-b); color:var(--text)" />
              <label style="display:flex; align-items:center; gap:6px; font-size:12px"><input type="checkbox" data-tt-break="${idx}" ${slot.isBreak? 'checked':''}/> Break</label>
            </div>
            <button data-tt-del="${idx}" style="padding:6px 10px; border-radius:8px; background:var(--accent-3); color:#fff; font-weight:600">Delete</button>
          `;
          list.appendChild(row);
        });
        list.querySelectorAll('[data-tt-del]')?.forEach(btn => {
          btn.addEventListener('click', (e) => {
            const idx = parseInt(e.currentTarget.getAttribute('data-tt-del'));
            const data = loadTimetable();
            data[div][day].schedule.splice(idx,1);
            saveTimetable(data);
            renderTTList();
          });
        });
        list.querySelectorAll('[data-tt-time]')?.forEach(inp => inp.addEventListener('input', onTTEdit));
        list.querySelectorAll('[data-tt-subject]')?.forEach(inp => inp.addEventListener('input', onTTEdit));
        list.querySelectorAll('[data-tt-break]')?.forEach(inp => inp.addEventListener('change', onTTEdit));
      }
      function onTTEdit(e){
        const div = document.getElementById('tt-division').value;
        const day = getTodayKey();
        const data = loadTimetable();
        const target = e.target;
        const timeIdx = target.getAttribute('data-tt-time');
        const subjIdx = target.getAttribute('data-tt-subject');
        const breakIdx = target.getAttribute('data-tt-break');
        const idx = parseInt(timeIdx||subjIdx||breakIdx);
        if (!isNaN(idx)) {
          const slot = data[div][day].schedule[idx];
          if (timeIdx !== null) slot.time = target.value;
          if (subjIdx !== null) slot.subject = target.value;
          if (breakIdx !== null) slot.isBreak = target.checked;
          saveTimetable(data);
        }
      }

      // ---------- NOTES APP ----------
      function loadNotes() {
        try {
          const raw = localStorage.getItem('dpce_notes');
          notes = raw ? JSON.parse(raw) : [];
        } catch(e) {
          notes = [];
        }
      }

      function persistNotes() {
        try { localStorage.setItem('dpce_notes', JSON.stringify(notes)); } catch(e) {}
      }

      function renderNotesList(filterText = '', sort = 'updated-desc') {
        const list = document.getElementById('notes-list');
        if (!list) return;
        const needle = filterText.trim().toLowerCase();
        let items = notes.map(n => ({...n}));
        if (needle) {
          items = items.filter(n => (n.title||'').toLowerCase().includes(needle) || (n.content||'').toLowerCase().includes(needle) || (n.tags||[]).join(',').toLowerCase().includes(needle));
        }
        // sort
        const by = {
          'updated-desc': (a,b) => (b.updatedAt||0) - (a.updatedAt||0),
          'updated-asc': (a,b) => (a.updatedAt||0) - (b.updatedAt||0),
          'created-desc': (a,b) => (b.createdAt||0) - (a.createdAt||0),
          'created-asc': (a,b) => (a.createdAt||0) - (b.createdAt||0),
          'title-asc': (a,b) => (a.title||'').localeCompare(b.title||''),
          'title-desc': (a,b) => (b.title||'').localeCompare(a.title||'')
        }[sort];
        items.sort(by);
        // pinned first
        items.sort((a,b) => (b.pinned?1:0) - (a.pinned?1:0));

        list.innerHTML = '';
        items.forEach(n => {
          const row = document.createElement('div');
          row.style.cssText = `padding:10px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:${n.color||'var(--surface)'}; display:flex; gap:8px; align-items:center;`;
          row.dataset.noteId = n.id;
          row.innerHTML = `
            <div>${n.pinned ? 'üìå' : 'üóíÔ∏è'}</div>
            <div style="flex:1; min-width:0;">
              <div style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${n.title||'Untitled'}</div>
              <div class="muted" style="font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${stripHtml(n.content||'').slice(0,80)}</div>
            </div>
            <div class="muted" style="font-size:11px;">${formatShortDate(n.updatedAt||n.createdAt)}</div>
          `;
          row.addEventListener('click', () => openNote(n.id));
          list.appendChild(row);
        });
      }

      function stripHtml(html) {
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || '';
      }

      function formatShortDate(ts) {
        if (!ts) return '';
        const d = new Date(ts);
        return d.toLocaleString(undefined, { month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      }

      function newNote() {
        const id = 'n_' + Math.random().toString(36).slice(2,9);
        const now = Date.now();
        const note = { id, title:'', content:'', color:'var(--surface)', pinned:false, tags:[], createdAt:now, updatedAt:now };
        notes.unshift(note);
        activeNoteId = id;
        persistNotes();
        renderNotesList(document.getElementById('notes-search')?.value || '', document.getElementById('notes-sort')?.value || 'updated-desc');
        bindEditorTo(id);
      }

      function openNote(id) {
        activeNoteId = id;
        bindEditorTo(id);
      }

      function bindEditorTo(id) {
        const note = notes.find(n => n.id === id);
        if (!note) return;
        const title = document.getElementById('note-title');
        const tags = document.getElementById('note-tags');
        const color = document.getElementById('note-color');
        const editor = document.getElementById('note-editor');
        const pinBtn = document.getElementById('pin-note-btn');
        title.value = note.title||'';
        tags.value = (note.tags||[]).join(', ');
        color.value = toColorInputValue(note.color);
        editor.innerHTML = note.content||'';
        editor.style.background = note.color || 'var(--surface)';
        pinBtn.textContent = note.pinned ? 'üìå Pinned' : 'üìå Pin';
      }

      function toColorInputValue(color) {
        const ctx = document.createElement('canvas').getContext('2d');
        ctx.fillStyle = color || '#ffffff';
        return rgbToHex(ctx.fillStyle);
      }

      function rgbToHex(rgb) {
        const m = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
        if (!m) return '#ffffff';
        const r = parseInt(m[1]).toString(16).padStart(2,'0');
        const g = parseInt(m[2]).toString(16).padStart(2,'0');
        const b = parseInt(m[3]).toString(16).padStart(2,'0');
        return `#${r}${g}${b}`;
      }

      function updateActiveNote(partial) {
        const note = notes.find(n => n.id === activeNoteId);
        if (!note) return;
        Object.assign(note, partial, { updatedAt: Date.now() });
        persistNotes();
        renderNotesList(document.getElementById('notes-search')?.value || '', document.getElementById('notes-sort')?.value || 'updated-desc');
      }

      function deleteActiveNote() {
        if (!activeNoteId) return;
        const idx = notes.findIndex(n => n.id === activeNoteId);
        if (idx >= 0) {
          notes.splice(idx,1);
          activeNoteId = null;
          persistNotes();
          renderNotesList(document.getElementById('notes-search')?.value || '', document.getElementById('notes-sort')?.value || 'updated-desc');
          // clear editor
          document.getElementById('note-title').value = '';
          document.getElementById('note-tags').value = '';
          const editor = document.getElementById('note-editor');
          editor.innerHTML = '';
          editor.style.background = 'var(--surface)';
        }
      }

      // Toolbar actions
      function exec(cmd, value = null) {
        document.execCommand(cmd, false, value);
        const editor = document.getElementById('note-editor');
        updateActiveNote({ content: editor.innerHTML });
      }

      function insertChecklist() {
        const editor = document.getElementById('note-editor');
        const sel = window.getSelection();
        if (!sel || sel.rangeCount === 0) { editor.focus(); }
        const ul = document.createElement('ul');
        ul.style.listStyle = 'none';
        ul.style.paddingLeft = '0';
        const li = document.createElement('li');
        li.innerHTML = `<input type="checkbox" /> <span>Task</span>`;
        ul.appendChild(li);
        document.execCommand('insertHTML', false, ul.outerHTML);
        updateActiveNote({ content: editor.innerHTML });
      }

      function openNotesModal() {
        const modal = document.getElementById('notes-modal');
        modal.style.display = 'flex';
      }

      // Notes event bindings
      loadNotes();
      renderNotesList();

      document.getElementById('open-notes-fab')?.addEventListener('click', openNotesModal);
      document.getElementById('close-notes-btn')?.addEventListener('click', () => {
        document.getElementById('notes-modal').style.display = 'none';
      });
      document.getElementById('new-note-btn')?.addEventListener('click', newNote);
      document.getElementById('notes-search')?.addEventListener('input', (e) => {
        renderNotesList(e.target.value, document.getElementById('notes-sort')?.value || 'updated-desc');
      });
      document.getElementById('notes-sort')?.addEventListener('change', (e) => {
        renderNotesList(document.getElementById('notes-search')?.value || '', e.target.value);
      });
      document.getElementById('note-title')?.addEventListener('input', (e) => {
        updateActiveNote({ title: e.target.value });
      });
      document.getElementById('note-tags')?.addEventListener('input', (e) => {
        const tags = e.target.value.split(',').map(t => t.trim()).filter(Boolean);
        updateActiveNote({ tags });
      });
      document.getElementById('note-color')?.addEventListener('input', (e) => {
        const color = e.target.value;
        const editor = document.getElementById('note-editor');
        editor.style.background = color;
        updateActiveNote({ color });
      });
      document.getElementById('pin-note-btn')?.addEventListener('click', () => {
        const n = notes.find(n => n.id === activeNoteId);
        if (!n) return;
        n.pinned = !n.pinned;
        updateActiveNote({ pinned: n.pinned });
        bindEditorTo(activeNoteId);
      });
      document.getElementById('delete-note-btn')?.addEventListener('click', () => {
        if (confirm('Delete this note?')) deleteActiveNote();
      });
      // Toolbar buttons
      document.querySelectorAll('.ntb[data-cmd]')?.forEach(btn => {
        btn.addEventListener('click', () => exec(btn.getAttribute('data-cmd')));
      });
      document.getElementById('checkbox-list-btn')?.addEventListener('click', insertChecklist);
      document.getElementById('link-btn')?.addEventListener('click', () => {
        const url = prompt('Enter URL');
        if (url) exec('createLink', url);
      });
      document.getElementById('text-color')?.addEventListener('input', (e) => exec('foreColor', e.target.value));
      document.getElementById('hilite-color')?.addEventListener('input', (e) => exec('hiliteColor', e.target.value));
      document.getElementById('clear-format-btn')?.addEventListener('click', () => exec('removeFormat'));
      // Editor input autosave
      const editorEl = document.getElementById('note-editor');
      let saveTimer = null;
      editorEl?.addEventListener('input', () => {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(() => updateActiveNote({ content: editorEl.innerHTML }), 300);
      });
      // Export/Import
      document.getElementById('export-notes-btn')?.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(notes, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'notes-export.json';
        a.click();
        URL.revokeObjectURL(a.href);
      });
      document.getElementById('import-notes-btn')?.addEventListener('click', () => {
        document.getElementById('import-notes-input').click();
      });
      document.getElementById('import-notes-input')?.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const text = await file.text();
        try {
          const data = JSON.parse(text);
          if (Array.isArray(data)) {
            notes = data;
            persistNotes();
            renderNotesList();
            showNotification('Notes imported successfully', 'success');
          } else {
            showNotification('Invalid import file', 'warning');
          }
        } catch(err) {
          showNotification('Failed to import notes', 'warning');
        }
      });
    });
  </script>
</body>
</html>